<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>每日血压记录应用增强版</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF + autoTable 插件 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    @media print {
      body * { visibility: hidden; }
      #printable-area, #printable-area * { visibility: visible; }
      #printable-area { position: absolute; left: 0; top: 0; width: 100%; font-family: 'Inter', sans-serif; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="p-4">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl mx-auto p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center">每日血压记录</h1>

    <!-- 历史与打印 -->
    <div class="space-y-6">
      <h2 class="text-xl font-semibold">历史与打印</h2>
      <div>
        <label class="block mb-1">开始日期</label>
        <input type="date" id="start-date" class="w-full border px-2 py-1 rounded">
      </div>
      <div>
        <label class="block mb-1">结束日期</label>
        <input type="date" id="end-date" class="w-full border px-2 py-1 rounded">
      </div>
      <div class="flex space-x-4">
        <button id="print-btn" class="flex-1 bg-purple-600 text-white py-2 rounded">打印选定日期的记录</button>
        <button id="export-pdf-btn" class="flex-1 bg-red-600 text-white py-2 rounded">导出 PDF</button>
      </div>
    </div>

    <!-- Chart.js 图表 -->
    <div class="bg-gray-50 p-4 rounded-xl">
      <h2 class="text-lg font-semibold">血压趋势图</h2>
      <canvas id="myChart" height="200"></canvas>
    </div>
  </div>

  <!-- 打印区域 -->
  <div id="printable-area" class="hidden">
    <h1 class="text-2xl font-bold mb-4">血压记录报告</h1>
    <p id="print-date-range" class="text-gray-600 mb-4"></p>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr>
          <th class="border-b-2 py-2">日期</th>
          <th class="border-b-2 py-2">时间段</th>
          <th class="border-b-2 py-2">收缩压 (mmHg)</th>
          <th class="border-b-2 py-2">舒张压 (mmHg)</th>
          <th class="border-b-2 py-2">脉搏 (bpm)</th>
          <th class="border-b-2 py-2">备注</th>
        </tr>
      </thead>
      <tbody id="print-data-body"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCpHJVVOQy51sPh6sU3GRotLG1v54IjXmk",
      authDomain: "gaoxueyajilu.firebaseapp.com",
      projectId: "gaoxueyajilu",
      storageBucket: "gaoxueyajilu.firebasestorage.app",
      messagingSenderId: "902988573811",
      appId: "1:902988573811:web:00cee1c09af3b9c96b0e06",
      measurementId: "G-SGN0D6BGJ6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;
    let allReadings = [];
    let chartInstance = null;

    const startDateInput = document.getElementById("start-date");
    const endDateInput = document.getElementById("end-date");
    const printDataBody = document.getElementById("print-data-body");
    const printDateRange = document.getElementById("print-date-range");
    const printBtn = document.getElementById("print-btn");
    const exportPdfBtn = document.getElementById("export-pdf-btn");
    const myChartCanvas = document.getElementById("myChart");

    // 更新图表
    function updateChart(data) {
      if (chartInstance) chartInstance.destroy();
      const ctx = myChartCanvas.getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(r => r.timestamp.toDate().toLocaleDateString("zh-CN")),
          datasets: [
            { label: "收缩压", data: data.map(r => r.systolic), borderColor: "rgb(75,192,192)" },
            { label: "舒张压", data: data.map(r => r.diastolic), borderColor: "rgb(255,99,132)" },
            { label: "脉搏", data: data.map(r => r.pulse), borderColor: "rgb(255,159,64)" }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // 打印
    printBtn.addEventListener("click", () => {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      if (!startDate || !endDate) return alert("请选择开始和结束日期");

      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setDate(end.getDate() + 1);

      const filtered = allReadings.filter(r => {
        if (!r.timestamp) return false;
        const t = r.timestamp.toDate();
        return t >= start && t < end;
      }).sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());

      printDataBody.innerHTML = "";
      printDateRange.textContent = `日期范围：${startDate} 至 ${endDate}`;

      if (filtered.length === 0) {
        printDataBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">没有找到记录</td></tr>';
      } else {
        filtered.forEach(r => {
          const d = r.timestamp.toDate();
          const dateStr = d.toLocaleDateString("zh-CN");
          const timeStr = d.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" });
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="py-2 border-b">${dateStr} ${timeStr}</td>
            <td class="py-2 border-b">${r.timePeriod}</td>
            <td class="py-2 border-b">${r.systolic}</td>
            <td class="py-2 border-b">${r.diastolic}</td>
            <td class="py-2 border-b">${r.pulse}</td>
            <td class="py-2 border-b">${r.note || "无"}</td>
          `;
          printDataBody.appendChild(tr);
        });
      }
      window.print();
    });

    // 导出 PDF（带表格 + 图表）
    exportPdfBtn.addEventListener("click", async () => {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      if (!startDate || !endDate) return alert("请选择开始和结束日期");

      const start = new Date(startDate);
      const end = new Date(endDate);
      end.setDate(end.getDate() + 1);

      const filtered = allReadings.filter(r => {
        if (!r.timestamp) return false;
        const t = r.timestamp.toDate();
        return t >= start && t < end;
      }).sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate());

      if (filtered.length === 0) return alert("没有找到该日期范围内的记录");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("血压记录报告", 14, 20);
      doc.setFontSize(12);
      doc.text(`日期范围：${startDate} 至 ${endDate}`, 14, 30);

      // 表格
      const tableData = filtered.map(r => {
        const d = r.timestamp.toDate();
        return [
          d.toLocaleDateString("zh-CN"),
          d.toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" }),
          r.timePeriod,
          r.systolic,
          r.diastolic,
          r.pulse,
          r.note || "无"
        ];
      });
      doc.autoTable({
        head: [["日期", "时间", "时间段", "收缩压", "舒张压", "脉搏", "备注"]],
        body: tableData,
        startY: 40,
        theme: "grid",
      });

      // 图表截图
      if (chartInstance) {
        const imgData = myChartCanvas.toDataURL("image/png", 1.0);
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.addImage(imgData, "PNG", 14, finalY, 180, 90);
      }

      doc.save(`血压报告_${startDate}_至_${endDate}.pdf`);
    });

    // 实时监听
    function setupRealtimeListener() {
      if (!userId) return;
      const readingsPath = `/artifacts/gaoxueyajilu/users/${userId}/readings`;
      const q = query(collection(db, readingsPath), orderBy("timestamp", "desc"));
      onSnapshot(q, snapshot => {
        allReadings = [];
        snapshot.forEach(doc => allReadings.push({ id: doc.id, ...doc.data() }));
        updateChart(allReadings);
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userId = user.uid;
        setupRealtimeListener();
      } else {
        userId = null;
        allReadings = [];
        if (chartInstance) chartInstance.destroy();
      }
    });
  </script>
</body>
</html>
